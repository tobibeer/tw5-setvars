/*\
title: $:/plugins/tobibeer/setvars/widgets.js
type: application/javascript
module-type: widget

Allows to set multiple variables in one go joining widget attributes:

@preserve
\*/
(function(){"use strict";var e=require("$:/core/modules/widgets/widget.js").widget;var t=function(t,i){e.call(this);this.initialise(t,i)};t.prototype=Object.create(e.prototype);t.prototype.render=function(e,t){this.parentDomNode=e;this.computeAttributes();this.execute();this.renderChildren(e,t)};t.prototype.execute=function(){var e=this,t=function(t,i,s){var r,n,u,f=s[3],h=s[4],l=s[5],a=s[6],c=parseInt(f),o=parseInt(h),p=i||f||h;if(i){n=e.wiki.filterTiddlers(t,e)}else{n=f||h?$tw.utils.parseStringArray(t):[t]}r=n.length;if(r&&(f||h)){if(f==="n"){c=r}else if(f==="-n"){c=1}else if(!f){c=1}if(h==="n"){o=r}else if(h==="-n"){o=-(c<0?r+c+1:c)}else if(!h){o=1}u=c;c=Math.max(1,c<0?r+c+(o<0?o+2:1):o<0?c+o+1:c);o=Math.max(1,Math.abs(o));n=n.splice(c-1,o)}if(l&&!n.length){n.push(l)}return p?a!==undefined?n.join(a):$tw.utils.stringifyList(n):n[0]};this.set={};this.use={};$tw.utils.each(this.attributes,function(t,i){if(i.charAt(0)==="_"){e.use[i.substr(1)]=t}else{e.set[i]=t}});$tw.utils.each(e.set,function(i,s){var r,n,u,f="",h,l=/^(\[)?(\w+)(?:\[(-?\d*|-?n)(?:,(-?\d*|-?n))?\])?(?:\[([^\]]*)\])?(?:\[([^\]]*)\])?(\])?(?:\s|$)/,a=i;while(a){h=a;n=/^\s/.exec(a);if(n){a=a.substr(n[0].length)}n=/^\\([^\\]*)\\/.exec(a);if(n){f+=n[1];a=a.substr(n[0].length)}n=l.exec(a);if(n){u=e.use[n[2]];if(u){if(n[1]&&n[7]){f+=t(u,true,n)}else if(!n[1]&&!n[7]){f+=t(u,false,n)}else{f+="setvars: missing bracket"}}a=a.substr(n[0].length)}if(a===h){r=a.indexOf(" ");a=r<0?"":a.substr(r+1)}}e.setVariable(s,f)});this.makeChildWidgets()};t.prototype.refresh=function(e){var t=this.computeAttributes();if(Object.keys(t).length){this.refreshSelf();return true}return this.refreshChildren(e)};exports.setvars=t})();