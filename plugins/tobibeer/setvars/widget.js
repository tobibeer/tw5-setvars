/*\
title: $:/plugins/tobibeer/setvars/widgets.js
type: application/javascript
module-type: widget

Allows to set multiple variables in one go joining widget attributes:

@preserve
\*/
(function(){"use strict";var e=require("$:/core/modules/widgets/widget.js").widget;var t=function(t,i){e.call(this);this.initialise(t,i)};t.prototype=Object.create(e.prototype);t.prototype.render=function(e,t){this.parentDomNode=e;this.computeAttributes();this.execute();this.renderChildren(e,t)};t.prototype.execute=function(){var e=this,t=function(t,i,r){var s,n,f=r[3],a=r[4],l=r[5],u=r[6],h=parseInt(f),c=parseInt(a),o=i||f||a;if(i){n=e.wiki.filterTiddlers(t,e)}else{n=f||a?$tw.utils.parseStringArray(t):[t]}s=n.length;if(s&&(f||a)){if(f==="n"){h=s}else if(f==="-n"){h=1}else if(!f){h=1}if(a==="n"){c=s}else if(a==="-n"){c=-(h<0?s+h+1:h)}else if(!a){c=1}h=Math.max(1,h<0?s+h+(c<0?c+2:1):c<0?h+c+1:h);c=Math.max(1,Math.abs(c));n=n.splice(h-1,c)}if(!n.length&&l){n.push(l)}return o?u===undefined?$tw.utils.stringifyList(n):n.join(u):n[0]};this.$={vars:{},attr:{},set:{}};$tw.utils.each(this.attributes,function(t,i){if(i.charAt(0)==="_"){e.$.attr[i.substr(1)]=t}else{e.$.vars[i]=t}});$tw.utils.each(e.$.vars,function(i,r){var s,n,f,a,l,u="",h=0,c=0,o="",d=i,p=[[/^\s+/,1,function(){return false}],[/^\\([^\\]*)\\/,2,function(e){return e[1]}],[/^(if\s*\(|\?|\:|\|\||\))/i,0,function(e){if(e[1].substr(0,2).toLowerCase()==="if"){s=1;if(h){c=1}else{n=h=0;f=""}}else{switch(e[1]){case"||":if(u.length){h=1}break;case"?":if(s&&!c){n=f.length;h=!n;f=""}break;case")":if(s){if(n){o+=f}s=n=h=0;f=""}c=0;break}}return false}],[/^(\[)?(\w+)(?:\[(-?\d*|-?n)(?:,(-?\d*|-?n))?\])?(?:\[([^\]]*)\])?(?:\[([^\]]*)\])?(\])?/,2,function(i){var r=e.$.attr[i[2]];if(r===undefined){r=e.$.set[i[2]]}if(r){if(i[1]&&i[7]){r=t(r,true,i)}else if(!i[1]&&!i[7]){r=t(r,false,i)}else{r=null}}return r}]];while(d.length){l=d;var v="";$tw.utils.each(p,function(e){var t=e[0].exec(d);if(t){if(!h||!e[1]){v=e[2].call(this,t);if(v===null){v="error: missing bracket in setvars"}else if(v){u=v}}a=e[1]===2;d=d.substr(t[0].length);return false}});if(v){if(s){f+=v}else if(!h){o+=v}}if(!s&&a){h=0}if(l===d){o="error: invalid setvars syntax";d=""}}e.$.set[r]=o;e.setVariable(r,o)});this.makeChildWidgets()};t.prototype.refresh=function(e){var t=this.computeAttributes();if(Object.keys(t).length){this.refreshSelf();return true}return this.refreshChildren(e)};exports.setvars=t})();